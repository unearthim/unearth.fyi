<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Set to noindex so search engines don't find your login page -->
    <meta name="robots" content="noindex, nofollow">

    <title>Admin | unearth.fyi</title>

    <!-- Typography (Lora for Serif/Narrative, Inter for Sans/UI) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:ital,wght@0,400;0;500;0;600;0,700;1,400&display=swap" rel="stylesheet">

    <!-- Tailwind v3.4.1 -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- unearth.im Standard Configuration (Earth & Ink Palette) -->
    <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            // 'Earth & Ink' Palette (Light Mode)
            'background': '#F8F7F4', // Off-White
            'text': '#2E2E2E',       // Charcoal
            'accent-primary': '#A95C3D', // Burnt Sienna
            'accent-secondary': '#5A7D8C', // Slate Blue
          },
          fontFamily: {
            // 'The Manuscript & The Interface' Typography
            'serif': ['Lora', 'serif'],
            'sans': ['Inter', 'sans-serif'],
          }
        }
      }
    }
    </script>
    
    <!-- Custom focus ring style -->
    <style>
        .focus-brand-ring:focus {
            border-color: #A95C3D;
            box-shadow: 0 0 0 3px rgba(169, 92, 61, 0.3);
            outline: none;
        }
    </style>
</head>
<body class="bg-background text-text font-serif antialiased">

    <div class="relative min-h-screen py-24 px-4 sm:px-6 lg:px-8">

        <!-- Main Content -->
        <main class="max-w-2xl mx-auto" role="main">

            <!-- 'Grounded' Navigation -->
            <div class="mb-12 text-center sm:text-left">
                <a href="https://unearth.im" class="font-sans text-sm font-semibold tracking-wide uppercase text-text/70 hover:text-text transition-colors" aria-label="Back to unearth.im home">
                    &larr; Back to unearth.im
                </a>
            </div>

            <section class="text-center mb-16">
                <!-- Narrative Element: Uses font-serif (Lora) -->
                <h1 class="text-5xl md:text-7xl font-medium tracking-tight text-text">
                    unearth<span class="text-accent-primary">.fyi</span>
                </h1>
                
                <!-- Narrative Element: Uses font-serif (Lora) -->
                <article class="mt-8 text-lg md:text-xl leading-relaxed text-text/90 max-w-2xl mx-auto">
                    <p>
                        Foundry Admin Panel
                    </p>
                </article>
            </section>

            <!-- 
              ===============================================================
              LOGIN & POST CONTAINERS
              ===============================================================
            -->
            
            <!-- LOGIN FORM (Hidden by default) -->
            <section id="login-container" class="hidden bg-white rounded-lg shadow-sm border border-text/20 p-6 md:p-8">
                <h2 class="font-sans text-2xl font-semibold tracking-tight text-text mb-6 text-center">Admin Login</h2>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="email" class="font-sans text-sm font-medium text-text/90">Email</label>
                        <input type="email" id="email" required 
                               class="font-sans mt-1 block w-full rounded-lg border border-text/20 p-3 shadow-sm focus-brand-ring">
                    </div>
                    <div>
                        <label for="password" class="font-sans text-sm font-medium text-text/90">Password</label>
                        <input type="password" id="password" required 
                               class="font-sans mt-1 block w-full rounded-lg border border-text/20 p-3 shadow-sm focus-brand-ring">
                    </div>
                    
                    <button type="submit" 
                            class="font-sans w-full bg-accent-primary text-white font-semibold py-3 px-4 rounded-lg hover:bg-opacity-90 transition-colors">
                        Login
                    </button>
                    <p id="error-message" class="text-red-600 text-sm text-center h-4 font-sans"></p>
                </form>
            </section>

            <!-- POST FORM (Hidden by default) -->
            <section id="post-container" class="hidden bg-white rounded-lg shadow-sm border border-text/20 p-6 md:p-8">
                <h2 class="font-sans text-2xl font-semibold tracking-tight text-text mb-6 text-center">Create New Post</h2>
                <form id="post-form" class="space-y-4">
                    <div>
                        <label for="post-content" class="font-sans text-sm font-medium text-text/90">Message (HTML is ok)</label>
                        <textarea id="post-content" rows="4" required
                                  class="font-sans mt-1 block w-full rounded-lg border border-text/20 p-3 shadow-sm focus-brand-ring"></textarea>
                    </div>
                    
                    <div>
                        <label for="image-upload" class="font-sans text-sm font-medium text-text/90">Optional Image</label>
                        <input type="file" id="image-upload" accept="image/png, image/jpeg, image/gif"
                               class="font-sans mt-1 block w-full text-sm text-text/90 file:mr-4 file:py-2 file:px-4
                                      file:rounded-lg file:border-0 file:font-semibold
                                      file:bg-accent-primary file:text-white hover:file:bg-opacity-90 file:cursor-pointer">
                    </div>

                    <button type="submit" id="post-submit-btn" 
                            class="font-sans w-full bg-accent-primary text-white font-semibold py-3 px-4 rounded-lg hover:bg-opacity-90 transition-colors
                                   disabled:opacity-50 disabled:cursor-not-allowed">
                        Post to Feed
                    </button>
                    <p id="success-message" class="text-green-600 text-sm text-center h-4 font-sans"></p>
                </form>
                
                <button id="sign-out-btn" 
                        class="font-sans w-full border border-text/20 text-text/70 font-semibold py-3 px-4 rounded-lg hover:bg-background transition-colors mt-6">
                    Sign Out
                </button>
            </section>
            
        </main>

        <!-- Footer -->
        <footer class="">
            <div class="max-w-7xl mx-auto text-center py-12 mt-24 px-4 sm:px-6 lg:px-8">
                <p class="font-sans text-sm text-text/60">
                    &copy; <span id="current-year"></span> <a href="https://unearth.im" class="hover:text-accent-primary transition-colors" target="_blank" rel="noopener">unearth<span class="text-accent-primary">.im</span></a>
                </p>
            </div>
        </footer>
    </div>

    <!-- 
      ===============================================================
      FIREBASE SCRIPT (Logic is unchanged)
      ===============================================================
    -->
    <script type="module">
        // 1. Import functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import {
            getAuth,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import {
            getFirestore,
            collection,
            addDoc,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            uploadBytes, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";

        // 2. Your web app's Firebase configuration
        // (Remember to replace this with your NEWLY rotated key!)
        const firebaseConfig = {
          apiKey: "AIzaSyAEU3QcCzu4ZmwJpHhogu1hMpyRp2swUz8", // <-- PUT YOUR NEW KEY HERE
          authDomain: "jojo-4b593.firebaseapp.com",
          projectId: "jojo-4b593",
          storageBucket: "jojo-4b593.firebasestorage.app",
          messagingSenderId: "353107431611",
          appId: "1:353107431611:web:01ee6c26cf7632d744599e",
          measurementId: "G-W1QL3RK32R"
        };
        
        // 3. Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app); 
        document.getElementById('current-year').textContent = new Date().getFullYear();

        // 4. Get DOM elements
        const loginContainer = document.getElementById("login-container");
        const postContainer = document.getElementById("post-container");
        const loginForm = document.getElementById("login-form");
        const postForm = document.getElementById("post-form");
        const signOutBtn = document.getElementById("sign-out-btn");
        const errorMessage = document.getElementById("error-message");
        const successMessage = document.getElementById("success-message");
        const postSubmitBtn = document.getElementById("post-submit-btn");
        const imageUploadInput = document.getElementById("image-upload");

        // 5. MAIN LOGIC: Listen for auth state changes
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in!
                // We check if it's the admin UID from our rules
                if (user.uid === "kLeUOn0OonauTbjAzRxyR4awMon1") { // <-- PASTE YOUR UID AGAIN
                    loginContainer.style.display = "none";
                    postContainer.style.display = "block";
                } else {
                    // Not the admin, sign them out.
                    signOut(auth);
                    errorMessage.textContent = "Not an authorized user.";
                }
            } else {
                // User is signed out
                loginContainer.style.display = "block";
                postContainer.style.display = "none";
            }
        });

        // 6. Handle Login
        loginForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            errorMessage.textContent = "";

            signInWithEmailAndPassword(auth, email, password)
                .catch((error) => {
                    console.error("Login Error:", error.message);
                    if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                        errorMessage.textContent = "Error: Invalid email or password.";
                    } else {
                        errorMessage.textContent = "An error occurred. Please try again.";
                    }
                });
        });

        // 7. Handle Sign Out
        signOutBtn.addEventListener("click", () => {
            signOut(auth);
        });

        // 8. Handle New Post
        postForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const content = document.getElementById("post-content").value;
            const file = imageUploadInput.files[0];
            successMessage.textContent = "";

            if (!content.trim()) {
                // Don't use alert()
                errorMessage.textContent = "Post content can't be empty.";
                setTimeout(() => { errorMessage.textContent = ""; }, 3000);
                return;
            }

            postSubmitBtn.disabled = true;
            postSubmitBtn.textContent = "Processing...";

            let imageUrl = null; 

            try {
                if (file) {
                    postSubmitBtn.textContent = "Uploading Image...";
                    const storagePath = `microblog/${Date.now()}_${file.name}`;
                    const storageRef = ref(storage, storagePath);
                    const uploadResult = await uploadBytes(storageRef, file);
                    imageUrl = await getDownloadURL(uploadResult.ref);
                }

                postSubmitBtn.textContent = "Saving Post...";

                const postData = {
                    content: content,
                    timestamp: serverTimestamp()
                };
                if (imageUrl) {
                    postData.imageUrl = imageUrl;
                }

                await addDoc(collection(db, "microblog"), postData);
                
                successMessage.textContent = "Post successfully added!";
                postForm.reset(); 
                
                setTimeout(() => { successMessage.textContent = ""; }, 3000);

            } catch (error) {
                console.error("Error adding post: ", error);
                successMessage.textContent = "";
                errorMessage.textContent = "Error: Could not add post.";
                setTimeout(() => { errorMessage.textContent = ""; }, 3000);
            } finally {
                postSubmitBtn.disabled = false;
                postSubmitBtn.textContent = "Post to Feed";
            }
        });

    </script>
</body>
</html>